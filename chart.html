<!doctype html>
<div id="container"></div>
<style>
    body {
        background-color: oklch(27.9% 0.041 260.031);
    }
</style>
<script type="module">
    import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";
    import * as htl from "https://cdn.jsdelivr.net/npm/htl@0.3/+esm";

    const urlParams = new URLSearchParams(window.location.search);
    const data = urlParams.get("data");
    const rows = data.split("~").map((row) => {
        const [date, power] = row.split("-");
        return {
            date: new Date(parseInt(date, 36) * 1000),
            power: parseFloat(power),
        };
    });

    function isLocalMinMax(rows, i) {
        const d = rows[i];
        const prev = rows[i - 1];
        const next = rows[i + 1];

        if (!prev) return next.power > d.power ? "min" : "max";
        if (!next) return prev.power > d.power ? "min" : "max";

        if (prev.power < d.power && next.power < d.power) return "max";
        if (prev.power > d.power && next.power > d.power) return "min";
    }

    const plot = Plot.plot({
        margin: 64,
        marginLeft: 64 + 8,
        height: 900,
        width: 1600,
        grid: true,
        style: {
            width: "100%",
            fontSize: "17px",
            backgroundColor: "oklch(27.9% 0.041 260.031)",
            color: "oklch(55.4% 0.046 257.417)",
            fontFamily: "monospace",
        },
        y: { tickFormat: (d) => "" + d, label: null },
        marks: [
            () => htl.svg`<defs><linearGradient id="gradient" gradientTransform="rotate(90)">
                <stop offset="0%" stop-color="#0fdb9b" stop-opacity="0.5" />
                <stop offset="100%" stop-color="#0fdb9b" stop-opacity="0" />
              </linearGradient></defs>`,
            Plot.areaY(rows, {
                x: "date",
                y1: Math.min(...rows.map((r) => r.power)) - 100,
                y2: "power",
                curve: "monotone-x",
                fill: "url(#gradient)",
            }),
            Plot.lineY(rows, {
                x: "date",
                y: "power",
                curve: "monotone-x",
                stroke: "#0fdb9b",
                strokeWidth: 5,
            }),
            Plot.dot(rows, {
                x: "date",
                y: "power",
                stroke: "#0fdb9b",
                strokeWidth: 5,
                r: 5,
                fill: "oklch(27.9% 0.041 260.031)",
            }),
            ...[
                ["min", 1, "top"],
                ["max", -1, "bottom"],
            ].map(([minMax, dyMult, lineAnchor]) =>
                Plot.text(rows, {
                    x: "date",
                    y: "power",
                    text: (d) => `${d.power.toFixed(1)}`,
                    fill: "#90a1b9",
                    stroke: "#1d293d",
                    strokeWidth: 5,
                    filter: (_d, i) => {
                        const local = isLocalMinMax(rows, i);
                        return local === minMax;
                    },
                    dy: 16 * dyMult,
                    lineAnchor,
                }),
            ),
        ],
    });

    const div = document.querySelector("#container");
    div.append(plot);
</script>
